# Agentic Turing Machine - PR Validation
# Validates pull requests before merging

name: Validate PR

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - 'skills/**'
      - '*.py'
      - '*.sh'
      - 'requirements.txt'

jobs:
  validate-skills:
    name: Validate Agent Skills
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
      
      - name: Validate skill files
        run: |
          echo "üìã Validating agent skills in PR..."
          
          ERRORS=0
          
          for skill_dir in skills/*/; do
            skill_name=$(basename "$skill_dir")
            skill_file="$skill_dir/SKILL.md"
            
            if [ ! -f "$skill_file" ]; then
              echo "‚ùå Missing SKILL.md in $skill_dir"
              ERRORS=$((ERRORS + 1))
              continue
            fi
            
            # Check required sections
            for section in "Description" "Capabilities" "Instructions"; do
              if ! grep -q "## $section" "$skill_file"; then
                echo "‚ö†Ô∏è Missing '## $section' in $skill_file"
              fi
            done
            
            # Check file size (not empty)
            if [ ! -s "$skill_file" ]; then
              echo "‚ùå Empty SKILL.md in $skill_dir"
              ERRORS=$((ERRORS + 1))
              continue
            fi
            
            echo "‚úì $skill_name validated"
          done
          
          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Validation failed with $ERRORS errors"
            exit 1
          fi
          
          echo "‚úÖ All skills validated!"
      
      - name: Check Python code quality
        run: |
          echo "üêç Checking Python code..."
          
          # Check syntax
          for pyfile in *.py; do
            python -m py_compile "$pyfile"
            echo "‚úì $pyfile syntax OK"
          done
          
          echo "‚úÖ Python validation complete!"
      
      - name: Comment validation result
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Validation Passed!**\n\nAll agent skills and Python code validated successfully.'
            })

